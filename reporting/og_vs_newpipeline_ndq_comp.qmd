---
title: "Comparing OG vs New Pipeline Nemours NDQ Results"
format: 
  html:
    embed-resources: true
    html-table-processing: none
---

```{r setup, include=FALSE}
 
setwd('..')
source('setup/setup.R')

library(gt)

unloadNamespace('squba.gen')
unloadNamespace('plotly')

config('qry_site', 'nemours')

# Initialize list to collect all problems for export
all_problems <- list()

compare_results <- function(og_tbl,
                            new_tbl,
                            check_string = NULL){
  
  site_nm <- config('qry_site')
  
  og_tbl <- og_tbl %>%
    filter(site == site_nm) %>%
    collect()
  
  colnames(og_tbl) <- paste0(colnames(og_tbl), '_og')
  
  new_tbl <- new_tbl %>%
    filter(site == site_nm) %>%
    collect()
  
  colnames(new_tbl) <- paste0(colnames(new_tbl), '_new')
  
  if(check_string == 'bmc'){
    comp_tbl <- og_tbl %>%
      left_join(new_tbl, by = c('check_name_og' = 'check_name_new',
                                'concept_og' = 'concept_new'))
  }else if(check_string == 'cfd'){
    comp_tbl <- og_tbl %>%
      left_join(new_tbl, by = c('check_name_og' = 'check_name_new',
                                'visit_type_og' = 'visit_type_new'))
  }else if(check_string == 'dcon'){
    comp_tbl <- og_tbl %>%
      left_join(new_tbl, by = c('check_name_og' = 'check_name_new',
                                'cohort_label_og' = 'cohort_label_new'))
  }else if(check_string == 'vc'){
    comp_tbl <- og_tbl %>%
      left_join(new_tbl, by = c('check_name_og' = 'check_name_new',
                                'vocabulary_id_og' = 'vocabulary_id_new'))
  }else if(check_string == 'vs'){
    comp_tbl <- og_tbl %>%
      left_join(new_tbl, by = c('check_name_og' = 'check_name_new',
                                'concepts_og' = 'concepts_new'))
  }else{
    comp_tbl <- og_tbl %>%
      left_join(new_tbl, by = c('check_name_og' = 'check_name_new'))
  }
  
}

# Function to calculate percentage difference
calc_pct_diff <- function(legacy, new) {
  ifelse(legacy == 0 & new == 0, 0,
         ifelse(legacy == 0, NA,
                round(((new - legacy) / legacy) * 100, 1)))
}

# Function to get severity indicator
get_severity <- function(check_category) {
  case_when(
    check_category == "Correctness" ~ "ðŸ”´ High",
    check_category == "Consistency" ~ "ðŸŸ¡ Medium",
    check_category == "Completeness" ~ "ðŸŸ¡ Medium",
    check_category == "Concordance" ~ "ðŸŸ  Medium-High",
    check_category == "Conformance" ~ "ðŸŸ¡ Medium",
    TRUE ~ "âšª Unknown"
  )
}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

```

# Data Cycle Changes

Each check is looking at the counts of different tables for the current data model version. It also technically looks at previous, but I removed that since we already know they are the same.

**Key:** - `total_ct` = row count - `total_pt_ct` = patient count - `Î”` = difference (new - legacy) - `Î”%` = percent change

```{r}

dc_comp <- compare_results(og_tbl = results_tbl('dc_output') %>% 
                             filter(database_version == 'v60') %>%
                             select(site, check_name, total_ct, total_pt_ct),
                           new_tbl = results_tbl(in_schema('dqa_rox_trino',
                                                           'dc_output'))%>%
                             filter(database_version == 'v60') %>%
                             select(site, check_name, total_ct, total_pt_ct),
                           check_string = 'dc') %>%
  select(-c(site_og, site_new))

# Filter for problem rows only
dc_problems <- dc_comp %>%
  filter(total_ct_og != total_ct_new | total_pt_ct_og != total_pt_ct_new) %>%
  mutate(
    total_ct_diff = total_ct_new - total_ct_og,
    total_ct_pct = calc_pct_diff(total_ct_og, total_ct_new),
    total_pt_ct_diff = total_pt_ct_new - total_pt_ct_og,
    total_pt_ct_pct = calc_pct_diff(total_pt_ct_og, total_pt_ct_new)
  )

# Display summary
cat(paste0("**", nrow(dc_problems), " discrepancies found out of ", nrow(dc_comp), " total checks**\n\n"))

if(nrow(dc_problems) > 0) {
  # Add to global problems list
  all_problems$dc <- dc_problems %>%
    inner_join(read_codeset('dqa_check_descriptions', 'ccc') %>%
                 select(check_name, check_application, check_category, full_description),
               by = c('check_name_og' = 'check_name')) %>%
    mutate(check_type = "Data Cycle Changes") %>%
    select(check_type, check_name_og, check_application, check_category, everything())
  
  dc_problems %>%
    inner_join(read_codeset('dqa_check_descriptions', 'ccc') %>%
                 select(check_name, check_application, check_category, full_description),
               by = c('check_name_og' = 'check_name')) %>%
    mutate(severity = get_severity(check_category)) %>%
    select(severity, check_name_og, check_application, 
           total_ct_og, total_ct_new, total_ct_diff, total_ct_pct,
           total_pt_ct_og, total_pt_ct_new, total_pt_ct_diff, total_pt_ct_pct,
           full_description) %>%
    gt() %>%
    cols_label(
      severity = "Priority",
      check_name_og = "Check Name",
      check_application = "Application",
      total_ct_og = "Legacy",
      total_ct_new = "New",
      total_ct_diff = "Î”",
      total_ct_pct = "Î”%",
      total_pt_ct_og = "Legacy",
      total_pt_ct_new = "New",
      total_pt_ct_diff = "Î”",
      total_pt_ct_pct = "Î”%",
      full_description = "Description"
    ) %>%
    tab_spanner(label = "Row Count", columns = c(total_ct_og, total_ct_new, total_ct_diff, total_ct_pct)) %>%
    tab_spanner(label = "Patient Count", columns = c(total_pt_ct_og, total_pt_ct_new, total_pt_ct_diff, total_pt_ct_pct)) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c(total_ct_og, total_ct_new, total_ct_diff, total_ct_pct),
        rows = total_ct_og != total_ct_new
      )
    ) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c(total_pt_ct_og, total_pt_ct_new, total_pt_ct_diff, total_pt_ct_pct),
        rows = total_pt_ct_og != total_pt_ct_new
      )
    ) %>%
    fmt_number(columns = c(total_ct_og, total_ct_new, total_ct_diff, 
                           total_pt_ct_og, total_pt_ct_new, total_pt_ct_diff),
               decimals = 0) %>%
    fmt_number(columns = c(total_ct_pct, total_pt_ct_pct),
               decimals = 1,
               pattern = "{x}%") %>%
    tab_options(
      table.font.size = px(14),
      row.striping.include_table_body = TRUE
    ) %>%
    opt_interactive(use_pagination = FALSE, use_search = TRUE, use_compact_mode = TRUE)
} else {
  cat("âœ… **No discrepancies found - all checks match!**\n")
}

```

# Best Mapped Concepts

Basically just looks at a distribution of concepts that exist in the data, then we mark which ones are best/not best.

**Key:** - `total_rows`: total N rows in the domain - `total_pts`: total N patients in the domain - `concept_rows`: N rows specifically associated with the concept of interest - `concept_pts`: N patients specifically associated with the concept of interest

```{r}

bmc_comp <- compare_results(og_tbl = results_tbl('bmc_output') %>% 
                             filter(database_version == 'v60') %>%
                              select(site, check_name, concept, total_rows, total_pts,
                                     concept_rows, concept_pts),
                           new_tbl = results_tbl(in_schema('dqa_rox_trino',
                                                           'bmc_output'))%>%
                             filter(database_version == 'v60') %>%
                              select(site, check_name, concept, total_rows, total_pts,
                                     concept_rows, concept_pts),
                           check_string = 'bmc') %>%
  select(-c(site_og, site_new))

# Filter for problem rows only
bmc_problems <- bmc_comp %>%
  filter(total_rows_og != total_rows_new | total_pts_og != total_pts_new |
         concept_rows_og != concept_rows_new | concept_pts_og != concept_pts_new)

cat(paste0("**", nrow(bmc_problems), " discrepancies found out of ", nrow(bmc_comp), " total checks**\n\n"))

if(nrow(bmc_problems) > 0) {
  bmc_problems %>%
    inner_join(read_codeset('dqa_check_descriptions', 'ccc') %>%
                 select(check_name, check_application, full_description),
               by = c('check_name_og' = 'check_name')) %>%
    gt() %>%
    cols_label(
      check_name_og = "Check Name",
      concept_og = "Concept",
      check_application = "Application",
      full_description = "Description"
    ) %>%
    tab_spanner_delim(delim = '_', split = 'last', limit = 1, reverse = TRUE,
                      columns = !c('check_name_og', 'concept_og', 'check_application', 
                                   'full_description')) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('total_rows_og', 'total_rows_new'),
        rows = total_rows_og != total_rows_new
      )
    ) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('total_pts_og', 'total_pts_new'),
        rows = total_pts_og != total_pts_new
      )
    ) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('concept_rows_og', 'concept_rows_new'),
        rows = concept_rows_og != concept_rows_new
      )
    ) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('concept_pts_og', 'concept_pts_new'),
        rows = concept_pts_og != concept_pts_new
      )
    ) %>%
    tab_options(
      table.font.size = px(14),
      row.striping.include_table_body = TRUE
    ) %>%
    opt_interactive(use_pagination = FALSE, use_search = TRUE)
} else {
  cat("âœ… **No discrepancies found - all checks match!**\n")
}

```

# Clinical Fact Documentation

Looks to see whether or not visits of various types have an associated clinical fact. It computes counts with/without -- only included one here because thats really all we need to see for this purpose.

**Key:** - `total_visits`: total N of visits of that type - `total_pts`: total N of patients with a visit of that type - `no_fact_visits`: total N of visits WITHOUT a fact - `no_fact_pts`: total N of patients WITHOUT a visit with a fact

```{r}

cfd_comp <- compare_results(og_tbl = results_tbl('cfd_output') %>% 
                             filter(database_version == 'v60') %>%
                              select(site, check_name, visit_type, total_visits, total_pts,
                                     no_fact_visits, no_fact_pts),
                           new_tbl = results_tbl(in_schema('dqa_rox_trino',
                                                           'cfd_output'))%>%
                             filter(database_version == 'v60') %>%
                              select(site, check_name, visit_type, total_visits, total_pts,
                                     no_fact_visits, no_fact_pts),
                           check_string = 'cfd') %>%
  select(-c(site_og, site_new))

# Filter for problem rows only
cfd_problems <- cfd_comp %>%
  filter(total_visits_og != total_visits_new | total_pts_og != total_pts_new |
         no_fact_visits_og != no_fact_visits_new | no_fact_pts_og != no_fact_pts_new)

cat(paste0("**", nrow(cfd_problems), " discrepancies found out of ", nrow(cfd_comp), " total checks**\n\n"))

if(nrow(cfd_problems) > 0) {
  cfd_problems %>%
    inner_join(read_codeset('dqa_check_descriptions', 'ccc') %>%
                 select(check_name, check_application, full_description),
               by = c('check_name_og' = 'check_name')) %>%
    gt() %>%
    cols_label(
      check_name_og = "Check Name",
      visit_type_og = "Visit Type",
      check_application = "Application",
      full_description = "Description"
    ) %>%
    tab_spanner_delim(delim = '_', split = 'last', limit = 1, reverse = TRUE,
                      columns = !c('check_name_og', 'visit_type_og', 'check_application', 
                                   'full_description')) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('total_visits_og', 'total_visits_new'),
        rows = total_visits_og != total_visits_new
      )
    ) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('total_pts_og', 'total_pts_new'),
        rows = total_pts_og != total_pts_new
      )
    ) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('no_fact_visits_og', 'no_fact_visits_new'),
        rows = no_fact_visits_og != no_fact_visits_new
      )
    ) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('no_fact_pts_og', 'no_fact_pts_new'),
        rows = no_fact_pts_og != no_fact_pts_new
      )
    ) %>%
    tab_options(
      table.font.size = px(14),
      row.striping.include_table_body = TRUE
    ) %>%
    opt_interactive(use_pagination = FALSE, use_search = TRUE)
} else {
  cat("âœ… **No discrepancies found - all checks match!**\n")
}

```

# Expected Concepts Present

Looks to see if different variables are present in the data

**Key:** - `total_pt_ct`: the count of patients for the cohort we're looking at - `concept_pt_ct`: patients with the variable of interest

```{r}

ecp_comp <- compare_results(og_tbl = results_tbl('ecp_output') %>% 
                             filter(database_version == 'v60') %>%
                              select(site, check_name, total_pt_ct, concept_pt_ct),
                           new_tbl = results_tbl(in_schema('dqa_rox_trino',
                                                           'ecp_output'))%>%
                             filter(database_version == 'v60') %>%
                              select(site, check_name, total_pt_ct, concept_pt_ct),
                           check_string = 'ecp') %>%
  select(-c(site_og, site_new))

# Filter for problem rows only
ecp_problems <- ecp_comp %>%
  filter(total_pt_ct_og != total_pt_ct_new | concept_pt_ct_og != concept_pt_ct_new)

cat(paste0("**", nrow(ecp_problems), " discrepancies found out of ", nrow(ecp_comp), " total checks**\n\n"))

if(nrow(ecp_problems) > 0) {
  ecp_problems %>%
    inner_join(read_codeset('dqa_check_descriptions', 'ccc') %>%
                 select(check_name, check_application, full_description),
               by = c('check_name_og' = 'check_name')) %>%
    gt() %>%
    cols_label(
      check_name_og = "Check Name",
      check_application = "Application",
      full_description = "Description"
    ) %>%
    tab_spanner_delim(delim = '_', split = 'last', limit = 1, reverse = TRUE,
                      columns = !c('check_name_og', 'check_application', 
                                   'full_description')) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('total_pt_ct_og', 'total_pt_ct_new'),
        rows = total_pt_ct_og != total_pt_ct_new
      )
    ) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('concept_pt_ct_og', 'concept_pt_ct_new'),
        rows = concept_pt_ct_og != concept_pt_ct_new
      )
    ) %>%
    tab_options(
      table.font.size = px(14),
      row.striping.include_table_body = TRUE
    ) %>%
    opt_interactive(use_pagination = FALSE, use_search = TRUE)
} else {
  cat("âœ… **No discrepancies found - all checks match!**\n")
}

```

# Domain Concordance

Looking at the concordance / overlap between two cohorts

**Key:** - `value`: the count of patients meeting criteria for that cohort

```{r}

dcon_comp <- compare_results(og_tbl = results_tbl('dcon_output') %>% 
                             filter(database_version == 'v60') %>%
                              select(site, check_name, cohort_label, value),
                           new_tbl = results_tbl(in_schema('dqa_rox_trino',
                                                           'dcon_output'))%>%
                             filter(database_version == 'v60') %>%
                              select(site, check_name, cohort_label, value),
                           check_string = 'dcon') %>%
  select(-c(site_og, site_new))

# Filter for problem rows only
dcon_problems <- dcon_comp %>%
  filter(value_og != value_new)

cat(paste0("**", nrow(dcon_problems), " discrepancies found out of ", nrow(dcon_comp), " total checks**\n\n"))

if(nrow(dcon_problems) > 0) {
  dcon_problems %>%
    inner_join(read_codeset('dqa_check_descriptions', 'ccc') %>%
                 select(check_name, check_application, full_description),
               by = c('check_name_og' = 'check_name')) %>%
    gt() %>%
    cols_label(
      check_name_og = "Check Name",
      cohort_label_og = "Cohort Label",
      check_application = "Application",
      full_description = "Description"
    ) %>%
    tab_spanner_delim(delim = '_', split = 'last', limit = 1, reverse = TRUE,
                      columns = !c('check_name_og', 'cohort_label_og', 'check_application', 
                                   'full_description')) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('value_og', 'value_new'),
        rows = value_og != value_new
      )
    ) %>%
    tab_options(
      table.font.size = px(14),
      row.striping.include_table_body = TRUE
    ) %>%
    opt_interactive(use_pagination = FALSE, use_search = TRUE)
} else {
  cat("âœ… **No discrepancies found - all checks match!**\n")
}

```

# Date Plausibility

Looking to see whether dates are plausible based on 4 different comparators

**Key:** - `total_rows`: total N of rows in the domain - `implausible_row`: N of rows with an implausible date

```{r}

dp_comp <- compare_results(og_tbl = results_tbl('dp_output') %>% 
                            # filter(database_version == 'v60') %>%
                              select(site, check_name, total_rows, implausible_row),
                           new_tbl = results_tbl(in_schema('dqa_rox_trino',
                                                           'dp_output'))%>%
                             #filter(database_version == 'v60') %>%
                              select(site, check_name, total_rows, implausible_row),
                           check_string = 'dp') %>%
  select(-c(site_og, site_new))

# Filter for problem rows only
dp_problems <- dp_comp %>%
  filter(total_rows_og != total_rows_new | implausible_row_og != implausible_row_new)

cat(paste0("**", nrow(dp_problems), " discrepancies found out of ", nrow(dp_comp), " total checks**\n\n"))

if(nrow(dp_problems) > 0) {
  dp_problems %>%
    inner_join(read_codeset('dqa_check_descriptions', 'ccc') %>%
                 select(check_name, check_application, full_description),
               by = c('check_name_og' = 'check_name')) %>%
    gt() %>%
    cols_label(
      check_name_og = "Check Name",
      check_application = "Application",
      full_description = "Description"
    ) %>%
    tab_spanner_delim(delim = '_', split = 'last', limit = 1, reverse = TRUE,
                      columns = !c('check_name_og', 'check_application', 
                                   'full_description')) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('total_rows_og', 'total_rows_new'),
        rows = total_rows_og != total_rows_new
      )
    ) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('implausible_row_og', 'implausible_row_new'),
        rows = implausible_row_og != implausible_row_new
      )
    ) %>%
    tab_options(
      table.font.size = px(14),
      row.striping.include_table_body = TRUE
    ) %>%
    opt_interactive(use_pagination = FALSE, use_search = TRUE)
} else {
  cat("âœ… **No discrepancies found - all checks match!**\n")
}

```

# Missing Field: Visit ID

Looking at visit_occurrence_id compliance -- is it non-null and does it also exist in the visit_occurrence table

**Key:** - `total_ct`: total N of rows in the domain - `total_visits`: total N of visits in the domain - `missing_visits_total`: N of missing visits (either NA or FK violation)

**Note:** Immunization is supposed to have a lot of violations - that's normal due to the registry data that's populated here.

```{r}

mf_comp <- compare_results(og_tbl = results_tbl('mf_visitid_output') %>% 
                            # filter(database_version == 'v60') %>%
                              select(site, check_name, total_ct, total_visits,
                                     missing_visits_total),
                           new_tbl = results_tbl(in_schema('dqa_rox_trino',
                                                           'mf_visitid_output'))%>%
                             #filter(database_version == 'v60') %>%
                              select(site, check_name, total_ct, total_visits,
                                     missing_visits_total),
                           check_string = 'mf') %>%
  select(-c(site_og, site_new))

# Filter for problem rows only
mf_problems <- mf_comp %>%
  filter(total_ct_og != total_ct_new | total_visits_og != total_visits_new |
         missing_visits_total_og != missing_visits_total_new)

cat(paste0("**", nrow(mf_problems), " discrepancies found out of ", nrow(mf_comp), " total checks**\n\n"))

if(nrow(mf_problems) > 0) {
  mf_problems %>%
    inner_join(read_codeset('dqa_check_descriptions', 'ccc') %>%
                 select(check_name, check_application, full_description),
               by = c('check_name_og' = 'check_name')) %>%
    gt() %>%
    cols_label(
      check_name_og = "Check Name",
      check_application = "Application",
      full_description = "Description"
    ) %>%
    tab_spanner_delim(delim = '_', split = 'last', limit = 1, reverse = TRUE,
                      columns = !c('check_name_og', 'check_application', 
                                   'full_description')) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('total_ct_og', 'total_ct_new'),
        rows = total_ct_og != total_ct_new
      )
    ) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('total_visits_og', 'total_visits_new'),
        rows = total_visits_og != total_visits_new
      )
    ) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('missing_visits_total_og', 'missing_visits_total_new'),
        rows = missing_visits_total_og != missing_visits_total_new
      )
    ) %>%
    tab_options(
      table.font.size = px(14),
      row.striping.include_table_body = TRUE
    ) %>%
    opt_interactive(use_pagination = FALSE, use_search = TRUE)
} else {
  cat("âœ… **No discrepancies found - all checks match!**\n")
}

```

# Unmapped Concepts

Looks at unmapped (NA, mapped to a concept_id that indicates an unknown value) concepts

**Key:** - `total_rows`: total N of rows in the domain - `unmapped_rows`: N of unmapped rows in the domain

```{r}

uc_comp <- compare_results(og_tbl = results_tbl('uc_output') %>% 
                            # filter(database_version == 'v60') %>%
                              select(site, check_name, total_rows, unmapped_rows),
                           new_tbl = results_tbl(in_schema('dqa_rox_trino',
                                                           'uc_output'))%>%
                             #filter(database_version == 'v60') %>%
                              select(site, check_name, total_rows, unmapped_rows),
                           check_string = 'mf') %>%
  select(-c(site_og, site_new))

# Filter for problem rows only
uc_problems <- uc_comp %>%
  filter(total_rows_og != total_rows_new | unmapped_rows_og != unmapped_rows_new)

cat(paste0("**", nrow(uc_problems), " discrepancies found out of ", nrow(uc_comp), " total checks**\n\n"))

if(nrow(uc_problems) > 0) {
  uc_problems %>%
    inner_join(read_codeset('dqa_check_descriptions', 'ccc') %>%
                 select(check_name, check_application, full_description),
               by = c('check_name_og' = 'check_name')) %>%
    gt() %>%
    cols_label(
      check_name_og = "Check Name",
      check_application = "Application",
      full_description = "Description"
    ) %>%
    tab_spanner_delim(delim = '_', split = 'last', limit = 1, reverse = TRUE,
                      columns = !c('check_name_og', 'check_application', 
                                   'full_description')) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('total_rows_og', 'total_rows_new'),
        rows = total_rows_og != total_rows_new
      )
    ) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('unmapped_rows_og', 'unmapped_rows_new'),
        rows = unmapped_rows_og != unmapped_rows_new
      )
    ) %>%
    tab_options(
      table.font.size = px(14),
      row.striping.include_table_body = TRUE
    ) %>%
    opt_interactive(use_pagination = FALSE, use_search = TRUE)
} else {
  cat("âœ… **No discrepancies found - all checks match!**\n")
}

```

# Vocabulary Conformance

Makes sure the concepts in the domain align with vocabulary specs in the network

**Key:** - `total_denom_ct`: total N of rows in the domain - `total_concept_ct`: total N of distinct concepts in the domain - `total_viol_ct`: N of rows assc with the vocabulary listed - `total_concept_viol_ct`: N of concepts assc with the vocabulary listed

```{r}

vc_comp <- compare_results(og_tbl = results_tbl('vc_output') %>% 
                            # filter(database_version == 'v60') %>%
                              select(site, check_name, vocabulary_id, total_viol_ct,
                                     total_viol_concept_ct, total_denom_ct,
                                     total_concept_ct),
                           new_tbl = results_tbl(in_schema('dqa_rox_trino',
                                                           'vc_output'))%>%
                             #filter(database_version == 'v60') %>%
                              select(site, check_name, vocabulary_id, total_viol_ct,
                                     total_viol_concept_ct, total_denom_ct,
                                     total_concept_ct),
                           check_string = 'vc') %>%
  select(-c(site_og, site_new))

# Filter for problem rows only
vc_problems <- vc_comp %>%
  filter(total_viol_ct_og != total_viol_ct_new | 
         total_viol_concept_ct_og != total_viol_concept_ct_new |
         total_denom_ct_og != total_denom_ct_new | 
         total_concept_ct_og != total_concept_ct_new)

cat(paste0("**", nrow(vc_problems), " discrepancies found out of ", nrow(vc_comp), " total checks**\n\n"))

if(nrow(vc_problems) > 0) {
  vc_problems %>%
    inner_join(read_codeset('dqa_check_descriptions', 'ccc') %>%
                 select(check_name, check_application, full_description),
               by = c('check_name_og' = 'check_name')) %>%
    gt() %>%
    cols_label(
      check_name_og = "Check Name",
      vocabulary_id_og = "Vocabulary ID",
      check_application = "Application",
      full_description = "Description"
    ) %>%
    tab_spanner_delim(delim = '_', split = 'last', limit = 1, reverse = TRUE,
                      columns = !c('check_name_og', 'vocabulary_id_og', 'check_application', 
                                   'full_description')) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('total_viol_ct_og', 'total_viol_ct_new'),
        rows = total_viol_ct_og != total_viol_ct_new
      )
    ) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('total_viol_concept_ct_og', 'total_viol_concept_ct_new'),
        rows = total_viol_concept_ct_og != total_viol_concept_ct_new
      )
    ) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('total_denom_ct_og', 'total_denom_ct_new'),
        rows = total_denom_ct_og != total_denom_ct_new
      )
    ) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('total_concept_ct_og', 'total_concept_ct_new'),
        rows = total_concept_ct_og != total_concept_ct_new
      )
    ) %>%
    tab_options(
      table.font.size = px(14),
      row.striping.include_table_body = TRUE
    ) %>%
    opt_interactive(use_pagination = FALSE, use_search = TRUE)
} else {
  cat("âœ… **No discrepancies found - all checks match!**\n")
}

```

# Valueset Conformance

Checks that certain fields are in compliance with preset valuesets

**Key:** - `total_denom_ct`: total N of rows in the domain - `total_viol_ct`: N of rows assc with the concept listed (-999 means no violation was identified, so its just 0)

```{r}

vs_comp <- compare_results(og_tbl = results_tbl('vs_output') %>% 
                            # filter(database_version == 'v60') %>%
                              select(site, check_name, concepts, total_viol_ct,
                                     total_denom_ct),
                           new_tbl = results_tbl(in_schema('dqa_rox_trino',
                                                           'vs_output'))%>%
                             #filter(database_version == 'v60') %>%
                              select(site, check_name, concepts, total_viol_ct, 
                                     total_denom_ct),
                           check_string = 'vs') %>%
  select(-c(site_og, site_new))

# Filter for problem rows only
vs_problems <- vs_comp %>%
  filter(total_viol_ct_og != total_viol_ct_new | total_denom_ct_og != total_denom_ct_new)

cat(paste0("**", nrow(vs_problems), " discrepancies found out of ", nrow(vs_comp), " total checks**\n\n"))

if(nrow(vs_problems) > 0) {
  vs_problems %>%
    inner_join(read_codeset('dqa_check_descriptions', 'ccc') %>%
                 select(check_name, check_application, full_description),
               by = c('check_name_og' = 'check_name')) %>%
    gt() %>%
    cols_label(
      check_name_og = "Check Name",
      concepts_og = "Concepts",
      check_application = "Application",
      full_description = "Description"
    ) %>%
    tab_spanner_delim(delim = '_', split = 'last', limit = 1, reverse = TRUE,
                      columns = !c('check_name_og', 'concepts_og', 'check_application', 
                                   'full_description')) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('total_viol_ct_og', 'total_viol_ct_new'),
        rows = total_viol_ct_og != total_viol_ct_new
      )
    ) %>%
    tab_style(
      style = list(cell_fill(color = "#ffcccc"), cell_text(weight = "bold")),
      locations = cells_body(
        columns = c('total_denom_ct_og', 'total_denom_ct_new'),
        rows = total_denom_ct_og != total_denom_ct_new
      )
    ) %>%
    tab_options(
      table.font.size = px(14),
      row.striping.include_table_body = TRUE
    ) %>%
    opt_interactive(use_pagination = FALSE, use_search = TRUE)
} else {
  cat("âœ… **No discrepancies found - all checks match!**\n")
}

```

------------------------------------------------------------------------

# ðŸ“Š Summary & Export

```{r}

# Combine all problems into a single dataframe
if(length(all_problems) > 0) {
  
  all_problems_df <- bind_rows(all_problems)
  
  # Create summary by check type and severity
  summary_stats <- all_problems_df %>%
    group_by(check_type, check_category) %>%
    summarise(
      n_problems = n(),
      .groups = 'drop'
    ) %>%
    arrange(desc(n_problems))
  
  cat("## Executive Summary\n\n")
  cat(paste0("**Total Discrepancies Found: ", nrow(all_problems_df), "**\n\n"))
  
  summary_stats %>%
    mutate(severity = get_severity(check_category)) %>%
    select(severity, check_type, check_category, n_problems) %>%
    gt() %>%
    cols_label(
      severity = "Priority",
      check_type = "Check Type",
      check_category = "Category",
      n_problems = "# Issues"
    ) %>%
    tab_style(
      style = cell_fill(color = "#ffe6e6"),
      locations = cells_body(rows = grepl("ðŸ”´", severity))
    ) %>%
    tab_style(
      style = cell_fill(color = "#fff4e6"),
      locations = cells_body(rows = grepl("ðŸŸ ", severity))
    ) %>%
    tab_style(
      style = cell_fill(color = "#fffee6"),
      locations = cells_body(rows = grepl("ðŸŸ¡", severity))
    ) %>%
    tab_options(
      table.font.size = px(14),
      row.striping.include_table_body = TRUE
    )
  
  # Export to CSV
  output_file <- file.path("..", "results", paste0("pipeline_discrepancies_", format(Sys.Date(), "%Y%m%d"), ".csv"))
  
  # Ensure results directory exists
  if(!dir.exists(file.path("..", "results"))) {
    dir.create(file.path("..", "results"), recursive = TRUE)
  }
  
  write.csv(all_problems_df, output_file, row.names = FALSE)
  
  cat("\n\n")
  cat(paste0("ðŸ“ **Full discrepancy list exported to:** `results/pipeline_discrepancies_", format(Sys.Date(), "%Y%m%d"), ".csv`\n\n"))
  cat("This CSV contains all discrepancies with full details for issue tracking and team review.\n")
  
} else {
  cat("## ðŸŽ‰ No Discrepancies Found!\n\n")
  cat("The new development pipeline matches the legacy pipeline perfectly across all checks.\n")
}

```
